{% extends "base.html" %}

{% block title %}Student Dashboard - AI Enhanced Classroom{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-white">My Classrooms</h1>
    <button type="button" class="btn btn-gradient-blue" data-bs-toggle="modal" data-bs-target="#joinClassroomModal">
        <i data-feather="plus" class="me-2"></i>Join Classroom
    </button>
</div>

<!-- Classrooms Grid -->
{% if classrooms %}
    <div class="row g-4">
        {% for classroom in classrooms %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 gradient-blue rounded-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title text-white">{{ classroom.name }}</h5>
                            {% if classroom.quiz_stats.pending > 0 %}
                                <span class="badge badge-coral">
                                    {{ classroom.quiz_stats.pending }} pending {% if classroom.quiz_stats.pending == 1 %}quiz{% else %}quizzes{% endif %}
                                </span>
                            {% endif %}
                            {% if classroom.assignment_stats.active_now > 0 %}
                                <span class="badge bg-info">
                                    {{ classroom.assignment_stats.active_now }} active {% if classroom.assignment_stats.active_now == 1 %}assignment{% else %}assignments{% endif %}
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if classroom.description %}
                            <p class="card-text text-white-90">{{ classroom.description[:100] }}{% if classroom.description|length > 100 %}...{% endif %}</p>
                        {% endif %}
                        
                        <div class="mb-3">
                            <small class="text-white-80">
                                <i data-feather="user" class="me-1"></i>
                                Teacher: {{ classroom.teacher.full_name }}
                            </small>
                            {% if classroom.quiz_stats.pending > 0 %}
                                <div class="mt-2">
                                    <small class="text-yellow">
                                        <i data-feather="alert-circle" class="me-1"></i>
                                        You have {{ classroom.quiz_stats.pending }} {% if classroom.quiz_stats.pending == 1 %}quiz{% else %}quizzes{% endif %} to complete
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if classroom.quizzes_with_status %}
                            <div class="mb-3">
                                <h6 class="text-white mb-2">Class Quizzes:</h6>
                                <ul class="list-unstyled mb-0">
                                    {% for quiz_info in classroom.quizzes_with_status %}
                                        {% set quiz = quiz_info.quiz %}
                                        {% set status = quiz_info.status %}
                                        <li>
                                            <i class="fas fa-clipboard-list me-1 text-white-70"></i>
                                            <a href="{{ url_for('student_take_teacher_quiz', classroom_id=classroom.id, quiz_id=quiz.id) }}" class="text-white-80 text-decoration-none">
                                                {{ quiz.title }}
                                            </a>
                                            {% if status == 'Available' %}
                                                {% if quiz.time_limit_minutes %}
                                                    <small class="text-white-50 me-2">({{ quiz.time_limit_minutes }} min)</small>
                                                {% endif %}
                                                <a href="{{ url_for('student_take_teacher_quiz', classroom_id=classroom.id, quiz_id=quiz.id) }}" class="btn btn-sm btn-gradient-teal ms-2">
                                                    Take Quiz
                                                </a>
                                            {% else %}
                                                {% if status == 'Attempts Used' %}
                                                    <i class="fas fa-ban text-warning ms-2"></i> {# Attempts Used Icon #}
                                                {% elif status == 'Completed' %}
                                                     <span class="badge bg-success ms-2">Completed</span>
                                                     {# For now, no direct link to view results from dashboard, add if needed later #}
                                                {% elif status == 'Upcoming' %}
                                                    <span class="badge bg-info ms-2">Upcoming</span>
                                                {% elif status == 'Expired' %}
                                                    <span class="badge bg-danger ms-2">Expired</span>
                                                {% else %}
                                                    <span class="badge bg-secondary ms-2">{{ status }}</span> {# Fallback #}
                                                {% endif %}
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        {% if classroom.assignments_with_status %}
                            <div class="mb-3">
                                <h6 class="text-white mb-2">Class Assignments:</h6>
                                <ul class="list-unstyled mb-0">
                                    {% for assignment_info in classroom.assignments_with_status %}
                                        {% set assignment = assignment_info.assignment %}
                                        {% set status = assignment_info.status %}
                                        <li>
                                            <i class="fas fa-file-alt me-1 text-white-70"></i>
                                            <a href="{{ url_for('student_view_assignment', assignment_id=assignment.id) }}" class="text-white-80 text-decoration-none">
                                                {{ assignment.title }}
                                            </a>
                                            {% if status == 'Active' %}
                                                {% if assignment.deadline %}
                                                    <small class="text-white-50 ms-2">(Due: {{ assignment.deadline.strftime('%Y-%m-%d %H:%M') }})</small>
                                                {% else %}
                                                    <small class="text-white-50 ms-2">(No deadline)</small>
                                                {% endif %}
                                                <a href="{{ url_for('student_view_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-gradient-teal ms-2">
                                                    View Assignment
                                                </a>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">{{ status }}</span>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('student_classroom', classroom_id=classroom.id) }}" class="btn btn-sm btn-yellow">
                                <i data-feather="book-open" class="me-1"></i>Enter Class
                            </a>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <small class="text-white-80">
                                <i data-feather="file-text" class="me-1"></i>
                                {{ classroom.materials|length }} materials
                            </small>
                            <small class="text-white-80">
                                <i data-feather="help-circle" class="me-1"></i>
                                {% if classroom.quiz_stats.completed > 0 %}
                                    {{ classroom.quiz_stats.completed }} completed
                                {% endif %}
                                {% if classroom.quiz_stats.pending > 0 %}
                                    {% if classroom.quiz_stats.completed > 0 %}| {% endif %}
                                    <span class="text-yellow">{{ classroom.quiz_stats.pending }} pending</span>
                                {% endif %}
                            </small>
                            <small class="text-white-80">
                                {% if classroom.gold_medal_count is defined and classroom.gold_medal_count > 0 %}
                                    <i class="fas fa-medal text-warning me-1"></i>
                                    {{ classroom.gold_medal_count }} Gold Award{{ 's' if classroom.gold_medal_count != 1 else '' }}
                                    {% if classroom.gold_rank is defined and classroom.num_students_in_ranking is defined and classroom.num_students_in_ranking > 0 %}
                                        – Rank {{ classroom.gold_rank }} of {{ classroom.num_students_in_ranking }}
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-medal text-secondary me-1"></i>
                                    No Gold Awards Yet
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5">
        <i data-feather="book-plus" class="text-white-50 mb-3 icon-64"></i>
        <h3 class="text-white">No Classrooms Yet</h3>
        <p class="text-white-80">Join your first classroom using an invitation code from your teacher.</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#joinClassroomModal">
            <i data-feather="plus" class="me-2"></i>Join Your First Classroom
        </button>
    </div>
{% endif %}

<!-- AI Quiz Awards Card -->
{% if ai_quiz_awards %}
    <div class="card border-0 gradient-purple rounded-4 mt-4">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-white">
                <i data-feather="award" class="me-2 text-white"></i>AI Quiz Awards
            </h5>
            <button class="btn btn-sm btn-outline-dark" type="button" data-bs-toggle="collapse" data-bs-target="#aiQuizAwardsCollapse" aria-expanded="false" aria-controls="aiQuizAwardsCollapse">
                View Details
            </button>
        </div>
        <div class="card-body collapse" id="aiQuizAwardsCollapse">
            {% for classroom_id, awards_by_material in ai_quiz_awards.items() %}
                <h6 class="text-white-80 mb-3">{{ classroom_names.get(classroom_id, 'Unknown Classroom') }}</h6>
                <ul class="list-group list-group-flush mb-4">
                    {% for material_id, award_info in awards_by_material.items() %}
                        <li class="list-group-item border-secondary text-white d-flex justify-content-between align-items-center list-bg-dark">
                            <div>
                                <h6 class="mb-1 text-white">{{ award_info.material_title }}</h6>
                                <small class="text-white-80">
                                    Score:
                                    {% if award_info.score >= 80 %}
                                        <span class="badge bg-success">{{ "%.1f"|format(award_info.score) }}%</span>
                                    {% elif award_info.score >= 67 %}
                                        <span class="badge bg-warning text-dark">{{ "%.1f"|format(award_info.score) }}%</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ "%.1f"|format(award_info.score) }}%</span>
                                    {% endif %}
                                    |
                                    Attempts:
                                    {% if award_info.attempts == 1 %}
                                        <span class="badge bg-success">{{ award_info.attempts }}</span>
                                    {% elif award_info.attempts >= 2 and award_info.attempts <= 3 %}
                                        <span class="badge bg-warning text-dark">{{ award_info.attempts }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ award_info.attempts }}</span>
                                    {% endif %}
                                </small>
                            </div>
                            <div>
                                {% if award_info.award == 'gold' %}
                                    <i class="fas fa-medal text-warning icon-medal" title="Gold Award"></i> {# Gold medal icon #}
                                {% elif award_info.award == 'silver' %}
                                    <i class="fas fa-medal text-secondary icon-medal" title="Silver Award"></i> {# Silver medal icon #}
                                {% elif award_info.award == 'bronze' %}
                                    <i class="fas fa-medal text-danger icon-medal" title="Bronze Award"></i> {# Bronze medal icon #}
                                {% endif %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% endfor %}
        </div>
    </div>
{% endif %}

<!-- Join Classroom Modal -->
<div class="modal fade" id="joinClassroomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 gradient-blue">
            <div class="modal-header">
                <h5 class="modal-title text-white">Join Classroom</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('student_join_classroom') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="invitation_code" class="form-label text-white-80">Invitation Code</label>
                        <input type="text" class="form-control text-uppercase bg-dark text-white border-secondary" id="invitation_code" name="invitation_code" 
                               maxlength="6" placeholder="Enter 6-character code" required>
                        <div class="form-text text-white-50">Ask your teacher for the classroom invitation code</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-light">
                        <i data-feather="plus" class="me-2"></i>Join Classroom
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Auto-uppercase invitation code input
document.getElementById('invitation_code').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});
</script>
{% endblock %}
